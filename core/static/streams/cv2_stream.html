<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Streaming with Flask-SocketIO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.3/socket.io.js"></script>
    <script type="text/javascript" charset="utf-8">
        document.addEventListener('DOMContentLoaded', function () {
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            var recieved = false
            var oldMouseX = 0
            var oldMouseY = 0
            var isFullscreen = false
            var activeModifiers = []

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // frame handling
            socket.on('video_frame', function (data) {
                var img = document.getElementById('video_frame');
                img.src = 'data:image/webp;base64,' + data.image;
                recieved = true
            });

            async function main() {
                while (1) {
                    socket.emit('frame')
                    await sleep(50)
                }
            }

            
            
            
            // mouse handling
            document.getElementById("video_frame").addEventListener('mousemove', async function a(evt) {
                const mPos = getMousePos(evt);
                var x = Math.round(mPos.x - oldMouseX)
                var y = Math.round(mPos.y - oldMouseY)
                
                //console.log(`Mouse position x:${x}  y:${x}`)
                socket.emit('mouse', `${x}|${y}`)
                
                oldMouseX = mPos.x
                oldMouseY = mPos.y
            });

            const getMousePos = (evt) => {
                const pos = evt.currentTarget.getBoundingClientRect();
                return {
                    x: Math.round(evt.clientX - pos.left),
                    y: Math.round(evt.clientY - pos.top)
                };
            };

            function handleMouseMove(event) {
                // Use movementX and movementY to get cursor movement
                var movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
                var movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;

                if (isFullscreen) {
                    // Do something with the movement information
                    socket.emit('mouse', `${movementX}|${movementY}`)
                }
            }

            // click handling
            document.getElementById("stream").addEventListener('click', function a() {
                if (isFullscreen) {
                    socket.emit("click", "left")
                } else {
                    document.getElementById('stream').requestFullscreen();
                }
            });

            document.getElementById("stream").addEventListener('contextmenu', function a() {
                if (isFullscreen) {
                    socket.emit("click", "right")
                } else {
                    document.getElementById('stream').requestFullscreen();
                }
            });

            document.getElementById("stream").addEventListener('onauxclick', function a() {
                if (isFullscreen) {
                    socket.emit("click", "middle")
                } else {
                    document.getElementById('stream').requestFullscreen();
                }
            });




            // scroll handling
            function handleWheel(event) {
                // Access scroll information from the event
                var delta = (event.deltaY || event.detail || event.wheelDelta)*-1;
                
                // Do something with the scroll information
                console.log("Scroll delta:", delta);
                socket.emit('scroll', `S:${delta}`)
            }

            document.getElementById("stream").addEventListener('scroll', function(){
                var scrollX = Math.round(window.pageXOffset || document.documentElement.scrollLeft);
                var scrollY = Math.round(window.pageYOffset || document.documentElement.scrollTop);

            })
            


            // keyboard handling
            document.addEventListener("keydown", function(e) {
                e.preventDefault();
                e = e || window.event;
                // Add scripts here

                if (e.key.toString() == " ") {
                    socket.emit('keystroke', "space")
                    return
                }
                else if (['Meta', 'Control', 'Alt', 'Shift'].includes(e.key.toString())) { // check if its a modifier key
                    if (!activeModifiers.includes(e.key.toString())) { // if its not already pressed
                        activeModifiers.push(e.key.toString()) // append it to active modifiers
                        
                        socket.emit('modifiers', activeModifiers.join(','))
                    }
                    return
                }

                socket.emit('keystroke', e.key.toString())
            });

            document.addEventListener('keyup', function(e) {
                e.preventDefault();
                e = e || window.event;

                if (['Meta', 'Control', 'Alt', 'Shift'].includes(e.key.toString())) {
                    activeModifiers.pop(e.key.toString())

                    socket.emit('modifiers', activeModifiers.join(','))

                    console.log(activeModifiers)

                }
            })



            
            // fullscreen handling
            document.addEventListener('pointerlockchange', function () {
                if (document.pointerLockElement === document.getElementById('stream')) {
                    // Cursor is locked, add event listener for movement
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('wheel', handleWheel)
                } else {
                    // Cursor is unlocked, remove event listener for movement
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('wheel', handleWheel);
                }
            });

            document.addEventListener("fullscreenchange", function() {
                if (document.fullscreenElement) {
                    console.log(
                    `Element: ${document.fullscreenElement.id} entered fullscreen mode.`,
                    );
                    document.getElementById("stream").requestPointerLock();
                    isFullscreen = true
                } else {
                    console.log("Leaving fullscreen mode.");
                    isFullscreen = false
                }
            });

            main()
        });
    </script>

    <style>

        body {
            margin: 0;
        }

        .stream {
            cursor: none;
            height: 100%;
            width: 100%;
            padding: 0;
        }
        .stream-container {
            height: 99vh;
            width: 99vw;
        }
    </style>
</head>
<body>
    <div id="stream" class="stream-container">
        <img id="video_frame" alt="Video Stream" class="stream">
    </div>
</body>
</html>
